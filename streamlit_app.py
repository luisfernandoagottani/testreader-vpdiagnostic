import streamlit as st
import numpy as np
from PIL import Image
import joblib
import requests
import json
import h5py
from io import BytesIO
import pickle
import tensorflow as tf
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.image import ImageDataGenerator, img_to_array, load_img, array_to_img
import keras
# Page title
st.set_page_config(page_title='Predi√ß√£o de Diagn√≥stico por Imagem', page_icon='ü©∫')
st.title('ü©∫ Predi√ß√£o de Diagn√≥stico por Imagem')

st.info('Este aplicativo permite que os usu√°rios enviem uma imagem e obtenham uma previs√£o de diagn√≥stico usando um modelo pr√©-treinado...')

# Sidebar for test and model selection

st.header('Sele√ß√£o de teste diagn√≥stico')
test_option = st.selectbox("Escolha um teste:", ["ImmunoComb Peritonite Infecciosa Felina (PIF)"])
    
if test_option == "ImmunoComb Peritonite Infecciosa Felina (PIF)":
    model_url = "./pif/pif_20240607.joblib"  # Replace with the actual URL of your joblib file
    class_url = "./pif/pif_class_indices.json"
    description_url = "./pif/pif_class_descriptions.json"
    test_info = "Teste Dot-Elisa que determina no soro, plasma de gatos o n√≠vel de anticorpo IgG contra Coronav√≠rus Felino (FCoV). Gatos com Peritonite Infecciosa Felina (PIF) cont√©m altos n√≠veis de anticorpo antiCoronav√≠rus Felino. Tamb√©m pode ser utilizado l√≠quido peritonial como amostra. O resultado negativo √© √∫til para afastar um diagn√≥stico da PIF."

st.info(test_info)

@st.cache_resource
def load_model(url):
    model = joblib.load(model_url)
    return model

if model_url:
    try:
        st.write("Carregando modelo...")
        model = load_model(model_url)
        st.success("Modelo carregado com sucesso!")
    except Exception as e:
        st.error(f"Erro ao carregar modelo: {e}")

# Main section for image upload and prediction
st.header('Carregar imagem')
st.image('exemplo_teste.png', caption='Exemplo de fotografia', width=300)
uploaded_file = st.file_uploader("Selecione uma imagem, de prefer√™ncia com fundo branco e apenas um teste por vez...", type=["jpg", "jpeg", "png"])
if uploaded_file is not None:
    image = Image.open(uploaded_file)
    st.image(image, caption='Imagem carregada.', width=200)

    if model_url and model:
        st.write("Classificando...")
        def predict_image(image):
            img = load_img(image, target_size=(150, 150))
            x = img_to_array(img)
            x = np.expand_dims(x, axis=0)
            x /= 255.0
            preds = model.predict(x)
            return preds
        preds = predict_image(uploaded_file)
        # Read the JSON file
        with open(class_url, 'r') as file:
            class_indices = json.load(file)
        prediction_class = next(key for key, value in class_indices.items() if value == np.argmax(preds))
        # Read the JSON file
        with open(description_url, 'r') as file:
            descriptions_indices = json.load(file)
            
        resultados = descriptions_indices[prediction_class]
        if preds.max() > 0.8:
            st.write(f"Resultado: {resultados}")
            st.write(f"Confian√ßa: {round(preds.max()*100,2)} %")
        else:
            st.write("Pouca confian√ßa na previs√£o. Se for poss√≠vel, tente usar fundo branco e apenas um teste por vez.")
    else:
        st.warning("Carregar uma imagem para realizar a predi√ß√£o.")
else:
    st.warning("Carregar uma imagem para realizar a predi√ß√£o.")
